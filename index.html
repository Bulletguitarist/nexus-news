<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS NEWS â€” AI Broadcast</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Rajdhani:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --red: #ff1a2e;
  --cyan: #00f0ff;
  --gold: #ffcc00;
  --green: #00ff88;
  --dark: #02040a;
  --panel: #070b14;
  --panel2: #0b1120;
  --border: rgba(0,240,255,0.12);
  --border-bright: rgba(0,240,255,0.35);
  --text: #b8cce0;
  --text-dim: rgba(184,204,224,0.4);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--dark);
  color:var(--text);
  font-family:'Rajdhani',sans-serif;
  display:flex;flex-direction:column;
  position:relative;
}

/* Noise texture overlay */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  opacity:0.4;
}

/* Scanlines */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9998;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.08) 3px,rgba(0,0,0,0.08) 4px);
}

/* â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;height:52px;
  background:linear-gradient(90deg,#08001a 0%,var(--panel) 30%,var(--panel) 70%,#08001a 100%);
  border-bottom:1px solid var(--red);
  flex-shrink:0;position:relative;overflow:hidden;
  z-index:100;
}
.topbar-glow{
  position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--red) 20%,#ff6600 50%,var(--red) 80%,transparent);
  animation:glowSlide 4s ease-in-out infinite;
}
@keyframes glowSlide{0%,100%{opacity:0.6}50%{opacity:1}}

.logo{
  font-family:'Orbitron',sans-serif;
  font-size:22px;font-weight:900;letter-spacing:6px;
  color:#fff;display:flex;align-items:center;gap:12px;
}
.logo-icon{
  width:32px;height:32px;border:2px solid var(--red);
  display:flex;align-items:center;justify-content:center;
  position:relative;
}
.logo-icon::before{
  content:'';position:absolute;inset:-4px;border:1px solid rgba(255,26,46,0.3);
  animation:rotateBorder 8s linear infinite;
}
@keyframes rotateBorder{to{transform:rotate(360deg)}}
.logo-dot{width:8px;height:8px;background:var(--red);border-radius:50%;box-shadow:0 0 12px var(--red);animation:beat 1.2s ease-in-out infinite;}
@keyframes beat{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(0.6);opacity:0.5}}
.logo span{color:var(--red);}

.topbar-center{display:flex;align-items:center;gap:20px;}
.live-pill{
  display:flex;align-items:center;gap:6px;
  padding:4px 14px;background:rgba(255,26,46,0.1);
  border:1px solid var(--red);
  font-family:'Space Mono',monospace;font-size:10px;
  color:var(--red);letter-spacing:3px;
  text-shadow:0 0 12px var(--red);
}
.live-dot{width:6px;height:6px;background:var(--red);border-radius:50%;box-shadow:0 0 8px var(--red);animation:beat 0.8s ease-in-out infinite;}

.network-badge{
  font-family:'Space Mono',monospace;font-size:9px;
  color:var(--text-dim);letter-spacing:2px;
  padding:3px 10px;border:1px solid rgba(255,255,255,0.06);
}

.topbar-right{display:flex;align-items:center;gap:16px;}
.clock{font-family:'Orbitron',monospace;font-size:14px;color:var(--cyan);text-shadow:0 0 15px var(--cyan);letter-spacing:3px;}
.date-display{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;}

/* â•â• MAIN LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{display:grid;grid-template-columns:280px 1fr 290px;flex:1;overflow:hidden;min-height:0;}

/* â•â• LEFT PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.left-panel{
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
}

.section-label{
  font-family:'Space Mono',monospace;font-size:9px;
  letter-spacing:3px;color:var(--cyan);
  padding:8px 16px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;
  text-transform:uppercase;
  background:rgba(0,240,255,0.02);
}
.section-label .arrow{color:var(--red);font-size:7px;}

/* API Key section */
.api-section{padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2);}
.field-label{font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:5px;font-family:'Space Mono',monospace;text-transform:uppercase;}

.api-input-wrap{position:relative;display:flex;align-items:center;}
.api-input-wrap input{padding-right:36px;}
.eye-btn{
  position:absolute;right:8px;background:none;border:none;
  color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px;
}
.eye-btn:hover{color:var(--cyan);}

input,select,textarea{
  width:100%;
  background:rgba(0,240,255,0.02);
  border:1px solid var(--border);
  color:var(--text);
  padding:7px 10px;
  font-family:'Space Mono',monospace;font-size:10px;
  outline:none;transition:all 0.25s;letter-spacing:0.5px;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--cyan);
  box-shadow:0 0 0 1px rgba(0,240,255,0.1),0 0 16px rgba(0,240,255,0.08);
  background:rgba(0,240,255,0.04);
}
select option{background:var(--panel);}

.model-row{display:flex;gap:6px;margin-top:8px;}
.model-row select{flex:1;}

.save-btn{
  padding:6px 12px;
  background:rgba(0,240,255,0.06);
  border:1px solid var(--border-bright);
  color:var(--cyan);
  font-family:'Space Mono',monospace;font-size:9px;
  letter-spacing:1px;cursor:pointer;transition:all 0.2s;
  white-space:nowrap;
}
.save-btn:hover{background:rgba(0,240,255,0.15);box-shadow:0 0 12px rgba(0,240,255,0.15);}

.conn-row{
  display:flex;align-items:center;gap:8px;
  padding:6px 16px;border-bottom:1px solid var(--border);
  font-family:'Space Mono',monospace;font-size:9px;
}
.conn-indicator{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,0.15);transition:all 0.3s;}
.conn-indicator.ok{background:var(--green);box-shadow:0 0 8px var(--green);}
.conn-indicator.err{background:var(--red);box-shadow:0 0 8px var(--red);}
.conn-indicator.loading{background:var(--gold);animation:beat 0.6s ease-in-out infinite;}
.conn-label{color:var(--text-dim);letter-spacing:1px;flex:1;}
.test-conn-btn{
  background:none;border:1px solid var(--border);
  color:var(--cyan);font-family:'Space Mono',monospace;
  font-size:8px;padding:2px 8px;cursor:pointer;letter-spacing:1px;
  transition:all 0.2s;
}
.test-conn-btn:hover{border-color:var(--cyan);background:rgba(0,240,255,0.05);}

/* Topic grid */
.topic-section{padding:10px 16px;border-bottom:1px solid var(--border);}
.topics-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-top:8px;}
.topic-chip{
  background:rgba(0,240,255,0.03);
  border:1px solid var(--border);
  color:var(--text-dim);
  padding:6px 4px;
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;
  letter-spacing:0.5px;cursor:pointer;
  transition:all 0.2s;text-align:center;
  text-transform:uppercase;
}
.topic-chip:hover{border-color:rgba(0,240,255,0.3);color:var(--text);}
.topic-chip.active{
  background:rgba(0,240,255,0.08);
  border-color:var(--cyan);color:var(--cyan);
  box-shadow:0 0 10px rgba(0,240,255,0.08),inset 0 0 8px rgba(0,240,255,0.04);
}

/* Language toggle */
.lang-row{display:flex;gap:5px;padding:0 16px 10px;}
.lang-btn{
  flex:1;padding:6px;background:rgba(0,0,0,0.3);
  border:1px solid var(--border);color:var(--text-dim);
  font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;
  cursor:pointer;transition:all 0.2s;text-align:center;
}
.lang-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(255,204,0,0.06);}

/* Custom topic */
.custom-section{padding:0 16px 10px;}
.custom-section textarea{resize:none;height:48px;font-size:10px;}

/* Generate button */
.gen-btn{
  margin:0 16px 12px;
  padding:13px;
  background:linear-gradient(135deg,rgba(0,240,255,0.05),rgba(0,0,30,0.8));
  border:1px solid var(--cyan);
  color:var(--cyan);
  font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;
  letter-spacing:3px;cursor:pointer;
  transition:all 0.3s;position:relative;overflow:hidden;
  text-transform:uppercase;
}
.gen-btn::before{
  content:'';position:absolute;top:0;left:-100%;right:0;bottom:0;
  background:linear-gradient(90deg,transparent,rgba(0,240,255,0.12),transparent);
  transition:left 0.5s;
}
.gen-btn:hover::before{left:100%;}
.gen-btn:hover{
  background:rgba(0,240,255,0.1);
  box-shadow:0 0 25px rgba(0,240,255,0.25),0 0 60px rgba(0,240,255,0.08),inset 0 0 20px rgba(0,240,255,0.04);
}
.gen-btn:disabled{opacity:0.35;cursor:not-allowed;}
.gen-btn:disabled::before{display:none;}

/* System log */
.log-area{flex:1;overflow-y:auto;padding:8px 16px;min-height:0;}
.log-area::-webkit-scrollbar{width:2px;}
.log-area::-webkit-scrollbar-thumb{background:var(--border);}
.log-line{
  font-family:'Space Mono',monospace;font-size:9px;line-height:1.9;
  padding-left:8px;border-left:1px solid transparent;
  opacity:0;animation:fadeIn 0.3s forwards;
}
.log-line.i{border-color:var(--cyan);color:rgba(0,240,255,0.65);}
.log-line.s{border-color:var(--green);color:rgba(0,255,136,0.75);}
.log-line.e{border-color:var(--red);color:rgba(255,26,46,0.8);}
.log-line.w{border-color:var(--gold);color:rgba(255,204,0,0.75);}
@keyframes fadeIn{to{opacity:1}}

/* â•â• STAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage{
  position:relative;display:flex;flex-direction:column;overflow:hidden;
  background:radial-gradient(ellipse 120% 80% at 50% 110%,#050518,#020408 60%);
}

/* Ambient background orbs */
.orb{
  position:absolute;border-radius:50%;filter:blur(60px);pointer-events:none;
}
.orb-1{width:300px;height:300px;background:rgba(0,60,120,0.3);top:-50px;left:-80px;}
.orb-2{width:250px;height:250px;background:rgba(0,20,60,0.4);bottom:60px;right:-60px;}
.orb-3{width:200px;height:200px;background:rgba(60,0,80,0.2);top:30%;left:30%;}

/* Grid floor */
.floor-grid{
  position:absolute;bottom:0;left:0;right:0;height:40%;
  background:
    linear-gradient(90deg,rgba(0,240,255,0.05) 1px,transparent 1px),
    linear-gradient(rgba(0,240,255,0.05) 1px,transparent 1px);
  background-size:35px 35px;
  transform:perspective(350px) rotateX(72deg);
  transform-origin:bottom;
  -webkit-mask-image:linear-gradient(to top,rgba(0,0,0,0.5),transparent);
  mask-image:linear-gradient(to top,rgba(0,0,0,0.5),transparent);
}

/* Spotlight */
.spotlight{
  position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:400px;height:100%;
  background:radial-gradient(ellipse 50% 70% at 50% 0%,rgba(0,240,255,0.04),transparent 70%);
  pointer-events:none;
}

.canvas-wrap{
  flex:1;display:flex;align-items:center;justify-content:center;
  position:relative;min-height:0;
}

canvas#c{
  display:block;max-height:100%;
  filter:drop-shadow(0 0 30px rgba(0,240,255,0.1)) drop-shadow(0 20px 40px rgba(0,0,0,0.8));
}

/* HUD frame corners */
.hud{position:absolute;inset:12px;pointer-events:none;}
.hud-c{position:absolute;width:22px;height:22px;opacity:0.4;}
.hud-c.tl{top:0;left:0;border-top:1px solid var(--cyan);border-left:1px solid var(--cyan);}
.hud-c.tr{top:0;right:0;border-top:1px solid var(--cyan);border-right:1px solid var(--cyan);}
.hud-c.bl{bottom:65px;left:0;border-bottom:1px solid var(--cyan);border-left:1px solid var(--cyan);}
.hud-c.br{bottom:65px;right:0;border-bottom:1px solid var(--cyan);border-right:1px solid var(--cyan);}

/* Anchor label */
.anchor-label{
  position:absolute;bottom:50px;left:50%;transform:translateX(-50%);
  display:flex;flex-direction:column;align-items:center;gap:3px;
}
.anchor-name-text{
  font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;
  letter-spacing:5px;color:var(--cyan);
  text-shadow:0 0 20px var(--cyan),0 0 40px rgba(0,240,255,0.3);
  white-space:nowrap;
}
.anchor-sub{
  font-family:'Space Mono',monospace;font-size:8px;
  letter-spacing:3px;color:var(--text-dim);
}

/* Audio visualizer */
.visualizer{
  position:absolute;bottom:32px;left:50%;transform:translateX(-50%);
  display:flex;align-items:flex-end;gap:2px;height:18px;
}
.vbar{
  width:2px;background:var(--cyan);opacity:0.5;
  border-radius:1px;min-height:2px;
  transition:height 0.06s ease;
}

/* Speaking ring */
.speak-ring{
  position:absolute;bottom:28px;left:50%;transform:translateX(-50%);
  width:200px;height:2px;
  background:linear-gradient(90deg,transparent,var(--cyan),transparent);
  opacity:0;transition:opacity 0.3s;
}
.speak-ring.active{opacity:0.6;animation:ringPulse 1.5s ease-in-out infinite;}
@keyframes ringPulse{0%,100%{transform:translateX(-50%) scaleX(0.8);opacity:0.3}50%{transform:translateX(-50%) scaleX(1);opacity:0.8}}

/* Ticker */
.ticker{
  background:var(--red);
  padding:5px 0;overflow:hidden;flex-shrink:0;
  border-top:1px solid rgba(255,100,100,0.3);
  position:relative;
}
.ticker::before,.ticker::after{
  content:'';position:absolute;top:0;bottom:0;width:60px;z-index:2;
}
.ticker::before{left:0;background:linear-gradient(to right,var(--red),transparent);}
.ticker::after{right:0;background:linear-gradient(to left,var(--red),transparent);}
.ticker-track{display:flex;animation:tick 40s linear infinite;white-space:nowrap;}
.tick-item{
  font-family:'Space Mono',monospace;font-size:10px;font-weight:700;
  letter-spacing:1.5px;color:rgba(255,255,255,0.95);
  padding:0 28px;white-space:nowrap;
}
.tick-sep{color:rgba(255,255,255,0.35);margin:0 4px;}
@keyframes tick{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

/* â•â• RIGHT PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.right-panel{
  background:var(--panel);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
}

.script-area{
  flex:1;overflow-y:auto;
  padding:14px 16px;
  font-family:'Rajdhani',sans-serif;font-size:14px;line-height:1.75;
  min-height:0;
}
.script-area::-webkit-scrollbar{width:2px;}
.script-area::-webkit-scrollbar-thumb{background:var(--border);}

.script-placeholder{
  color:var(--text-dim);font-family:'Space Mono',monospace;
  font-size:10px;line-height:2.2;letter-spacing:0.5px;
  margin-top:10px;
}
.script-placeholder .step{
  display:flex;align-items:center;gap:10px;padding:3px 0;
}
.step-num{
  width:18px;height:18px;border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:8px;color:var(--cyan);flex-shrink:0;
}
.step-text{color:var(--text-dim);}

.w-hi{
  background:rgba(0,240,255,0.12);color:var(--cyan);
  border-radius:2px;padding:0 2px;
  box-shadow:0 0 6px rgba(0,240,255,0.2);
}

/* Progress */
.progress-track{height:2px;background:rgba(0,240,255,0.06);flex-shrink:0;}
.progress-fill{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--cyan),rgba(0,240,255,0.4));
  transition:width 0.4s;
  box-shadow:0 0 6px var(--cyan);
}

/* TTS controls */
.tts-panel{padding:10px 16px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px;}

.sliders-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.slider-group{}
input[type=range]{
  -webkit-appearance:none;appearance:none;
  width:100%;height:2px;
  background:rgba(0,240,255,0.12);outline:none;padding:0;border:none;
  border-radius:0;margin-top:6px;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;appearance:none;
  width:12px;height:12px;background:var(--cyan);
  border-radius:50%;cursor:pointer;
  box-shadow:0 0 8px var(--cyan);
}

.btn-row{display:flex;gap:6px;}
.ctrl-btn{
  flex:1;padding:11px 8px;
  background:rgba(0,0,0,0.3);
  border:1px solid var(--border);
  color:var(--text-dim);
  font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:2px;cursor:pointer;transition:all 0.2s;
}
.ctrl-btn.play{border-color:rgba(0,240,255,0.4);color:var(--cyan);background:rgba(0,240,255,0.04);}
.ctrl-btn.play:hover{background:rgba(0,240,255,0.1);box-shadow:0 0 16px rgba(0,240,255,0.2);}
.ctrl-btn.stop{border-color:rgba(255,26,46,0.4);color:var(--red);}
.ctrl-btn.stop:hover{background:rgba(255,26,46,0.08);box-shadow:0 0 16px rgba(255,26,46,0.2);}

/* Stats */
.stats-bar{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:6px;padding:8px 16px;
  border-top:1px solid var(--border);
}
.stat{
  background:rgba(0,0,0,0.3);border:1px solid var(--border);
  padding:6px 8px;text-align:center;
}
.stat-val{
  font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;
  color:var(--cyan);line-height:1;
  text-shadow:0 0 10px rgba(0,240,255,0.4);
}
.stat-lbl{
  font-family:'Space Mono',monospace;font-size:8px;
  letter-spacing:1px;color:var(--text-dim);margin-top:3px;
}

/* â•â• NOTIFICATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;top:62px;right:20px;
  padding:11px 18px;
  background:var(--panel2);
  border:1px solid var(--cyan);
  font-family:'Space Mono',monospace;font-size:10px;color:var(--cyan);
  z-index:9997;max-width:280px;line-height:1.5;
  transform:translateX(calc(100% + 30px));
  transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 0 24px rgba(0,240,255,0.15);
}
.toast.show{transform:translateX(0);}
.toast.err{border-color:var(--red);color:var(--red);box-shadow:0 0 24px rgba(255,26,46,0.15);}

/* â•â• INIT OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.init-overlay{
  position:absolute;inset:0;
  background:rgba(2,4,10,0.95);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:18px;z-index:200;transition:opacity 0.6s;
}
.init-overlay.gone{opacity:0;pointer-events:none;}
.init-title{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;letter-spacing:8px;color:var(--cyan);text-shadow:0 0 30px var(--cyan);}
.init-sub{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);}
.init-bar{width:180px;height:1px;background:rgba(0,240,255,0.1);overflow:hidden;}
.init-fill{height:100%;background:var(--cyan);box-shadow:0 0 8px var(--cyan);animation:initLoad 1.8s ease-in-out infinite;}
@keyframes initLoad{0%{width:0;margin-left:0}50%{width:70%;margin-left:15%}100%{width:0;margin-left:100%}}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">
    <div class="logo-icon"><div class="logo-dot"></div></div>
    <span>NEXUS</span>&nbsp;NEWS
  </div>
  <div class="topbar-center">
    <div class="live-pill"><div class="live-dot"></div>ON AIR</div>
    <div class="network-badge">AI BROADCAST NETWORK</div>
  </div>
  <div class="topbar-right">
    <div class="date-display" id="dateDisp"></div>
    <div class="clock" id="clockDisp">--:--:--</div>
  </div>
  <div class="topbar-glow"></div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- LEFT -->
  <div class="left-panel">
    <div class="section-label"><span class="arrow">â–¶</span> Groq API Setup</div>

    <div class="api-section">
      <div class="field-label">API KEY</div>
      <div class="api-input-wrap">
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        <button class="eye-btn" onclick="toggleKey()" id="eyeBtn">ğŸ‘</button>
      </div>
      <div class="model-row">
        <select id="modelSel">
          <option value="llama-3.3-70b-versatile">Llama 3.3 70B</option>
          <option value="llama-3.1-8b-instant" selected>Llama 3.1 8B âš¡</option>
          <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
          <option value="gemma2-9b-it">Gemma 2 9B</option>
        </select>
        <button class="save-btn" onclick="saveKey()">SAVE</button>
      </div>
      <div style="margin-top:6px;font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);line-height:1.7">
        Free at <span style="color:var(--cyan)">console.groq.com</span><br>
        14,400 reqs/day â€¢ No backend needed
      </div>
    </div>

    <div class="conn-row">
      <div class="conn-indicator" id="connDot"></div>
      <span class="conn-label" id="connLbl">NOT CONFIGURED</span>
      <button class="test-conn-btn" onclick="testGroq()">PING</button>
    </div>

    <div class="section-label"><span class="arrow">â–¶</span> Topic</div>
    <div class="topic-section">
      <div class="topics-grid" id="topicGrid">
        <button class="topic-chip active" data-t="world news">ğŸŒ World</button>
        <button class="topic-chip" data-t="technology">ğŸ’» Tech</button>
        <button class="topic-chip" data-t="science">ğŸ”¬ Science</button>
        <button class="topic-chip" data-t="finance markets">ğŸ“ˆ Finance</button>
        <button class="topic-chip" data-t="space exploration">ğŸš€ Space</button>
        <button class="topic-chip" data-t="sports">âš½ Sports</button>
        <button class="topic-chip" data-t="health wellness">â¤ï¸ Health</button>
        <button class="topic-chip" data-t="entertainment">ğŸ¬ Entertain</button>
        <button class="topic-chip" data-t="politics">ğŸ›ï¸ Politics</button>
      </div>
    </div>

    <div class="section-label"><span class="arrow">â–¶</span> Language</div>
    <div class="lang-row">
      <button class="lang-btn active" data-lang="english" onclick="setLang(this)">ğŸ‡ºğŸ‡¸ ENGLISH</button>
      <button class="lang-btn" data-lang="hindi" onclick="setLang(this)">ğŸ‡®ğŸ‡³ HINDI</button>
      <button class="lang-btn" data-lang="hinglish" onclick="setLang(this)">ğŸ”€ HINGLISH</button>
    </div>

    <div class="custom-section">
      <div class="field-label">Custom Topic</div>
      <textarea id="custTopic" placeholder="Enter your own topic..."></textarea>
    </div>

    <button class="gen-btn" id="genBtn" onclick="generate()">âš¡ GENERATE</button>

    <div class="section-label"><span class="arrow">â–¶</span> System Log</div>
    <div class="log-area" id="logArea">
      <div class="log-line i">// NEXUS NEWS v3.0 â€” GROQ EDITION</div>
      <div class="log-line i">// No backend needed</div>
      <div class="log-line w">// Get free API key: console.groq.com</div>
    </div>
  </div>

  <!-- STAGE -->
  <div class="stage">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <div class="floor-grid"></div>
    <div class="spotlight"></div>

    <div class="canvas-wrap">
      <div class="hud">
        <div class="hud-c tl"></div>
        <div class="hud-c tr"></div>
        <div class="hud-c bl"></div>
        <div class="hud-c br"></div>
      </div>

      <canvas id="c" width="460" height="480"></canvas>

      <div class="anchor-label">
        <div class="anchor-name-text">A.I. NEXUS</div>
        <div class="anchor-sub">CHIEF AI ANCHOR</div>
      </div>

      <div class="speak-ring" id="speakRing"></div>
      <div class="visualizer" id="viz"></div>

      <div class="init-overlay" id="initOverlay">
        <div class="init-title">NEXUS NEWS</div>
        <div class="init-sub">INITIALIZING BROADCAST SYSTEM</div>
        <div class="init-bar"><div class="init-fill"></div></div>
      </div>
    </div>

    <div class="ticker">
      <div class="ticker-track" id="tickerTrack">
        <span class="tick-item">NEXUS NEWS AI BROADCAST NETWORK <span class="tick-sep">///</span></span>
        <span class="tick-item">POWERED BY GROQ + LLAMA 3 <span class="tick-sep">///</span></span>
        <span class="tick-item">100% FREE â€” NO BACKEND REQUIRED <span class="tick-sep">///</span></span>
        <span class="tick-item">GET YOUR FREE API KEY AT CONSOLE.GROQ.COM <span class="tick-sep">///</span></span>
        <span class="tick-item">SELECT A TOPIC AND CLICK GENERATE <span class="tick-sep">///</span></span>
        <span class="tick-item">NEXUS NEWS AI BROADCAST NETWORK <span class="tick-sep">///</span></span>
        <span class="tick-item">POWERED BY GROQ + LLAMA 3 <span class="tick-sep">///</span></span>
        <span class="tick-item">100% FREE â€” NO BACKEND REQUIRED <span class="tick-sep">///</span></span>
        <span class="tick-item">GET YOUR FREE API KEY AT CONSOLE.GROQ.COM <span class="tick-sep">///</span></span>
        <span class="tick-item">SELECT A TOPIC AND CLICK GENERATE <span class="tick-sep">///</span></span>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right-panel">
    <div class="section-label"><span class="arrow">â–¶</span> Broadcast Script</div>

    <div class="script-area" id="scriptArea">
      <div class="script-placeholder">
        <div class="step"><div class="step-num">01</div><div class="step-text">Get free key at console.groq.com</div></div>
        <div class="step"><div class="step-num">02</div><div class="step-text">Paste API key on the left</div></div>
        <div class="step"><div class="step-num">03</div><div class="step-text">Click PING to verify</div></div>
        <div class="step"><div class="step-num">04</div><div class="step-text">Choose a topic</div></div>
        <div class="step"><div class="step-num">05</div><div class="step-text">Click âš¡ GENERATE</div></div>
        <div class="step"><div class="step-num">06</div><div class="step-text">Hit â–¶ BROADCAST & watch!</div></div>
      </div>
    </div>

    <div class="progress-track"><div class="progress-fill" id="progFill"></div></div>

    <div class="tts-panel">
      <div class="field-label">Voice</div>
      <select id="voiceSel"></select>

      <div class="sliders-row">
        <div class="slider-group">
          <div class="field-label">Speed <span id="rateVal" style="color:var(--cyan)">0.9x</span></div>
          <input type="range" id="rateR" min="0.5" max="2" step="0.05" value="0.9">
        </div>
        <div class="slider-group">
          <div class="field-label">Pitch <span id="pitchVal" style="color:var(--cyan)">0.9</span></div>
          <input type="range" id="pitchR" min="0.1" max="2" step="0.05" value="0.9">
        </div>
      </div>

      <div class="btn-row">
        <button class="ctrl-btn play" onclick="broadcast()">â–¶ BROADCAST</button>
        <button class="ctrl-btn stop" onclick="stopBroadcast()">â–  STOP</button>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat"><div class="stat-val" id="stWords">0</div><div class="stat-lbl">WORDS</div></div>
      <div class="stat"><div class="stat-val" id="stSent">0</div><div class="stat-lbl">SENTENCES</div></div>
      <div class="stat"><div class="stat-val" id="stTime">0s</div><div class="stat-lbl">DURATION</div></div>
      <div class="stat"><div class="stat-val" id="stLang">EN</div><div class="stat-lbl">LANGUAGE</div></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let apiKey = localStorage.getItem('groq_key') || '';
let currentTopic = 'world news';
let currentLang = 'english';
let script = '';
let scriptWords = [];
let wordEls = [];
let speaking = false;
let mouthOpen = 0, targetMouth = 0;
let eyeBlink = 0, breathPhase = 0, glowPulse = 0;
let voices = [];
let utt = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (apiKey) {
  document.getElementById('apiKey').value = apiKey;
  document.getElementById('connDot').className = 'conn-indicator ok';
  document.getElementById('connLbl').textContent = 'API KEY LOADED';
}

setTimeout(() => {
  document.getElementById('initOverlay').classList.add('gone');
  log('System initialized', 's');
  log('Web Speech API ready', 's');
  if (apiKey) log('API key loaded from storage', 's');
}, 2200);

// Clock
setInterval(() => {
  const n = new Date();
  document.getElementById('clockDisp').textContent = n.toTimeString().slice(0,8);
  document.getElementById('dateDisp').textContent = n.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}).toUpperCase();
}, 1000);

// Slider display
document.getElementById('rateR').addEventListener('input', function() {
  document.getElementById('rateVal').textContent = parseFloat(this.value).toFixed(2) + 'x';
  updateStats();
});
document.getElementById('pitchR').addEventListener('input', function() {
  document.getElementById('pitchVal').textContent = parseFloat(this.value).toFixed(2);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVoices() {
  voices = window.speechSynthesis.getVoices();
  const sel = document.getElementById('voiceSel');
  sel.innerHTML = '';
  const eng = voices.filter(v => v.lang.startsWith('en'));
  const others = voices.filter(v => !v.lang.startsWith('en'));
  [...eng, ...others].forEach((v, i) => {
    const idx = voices.indexOf(v);
    const o = document.createElement('option');
    o.value = idx;
    o.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(o);
  });
  // pick a nice default
  const pref = voices.findIndex(v =>
    v.name.includes('Google UK English Male') ||
    v.name.includes('Daniel') ||
    (v.lang === 'en-GB' && v.name.includes('Male'))
  );
  if (pref >= 0) sel.value = pref;
  if (voices.length) log(`${voices.length} voices loaded`, 's');
}
window.speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices, 600);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function log(msg, type = 'i') {
  const el = document.createElement('div');
  el.className = `log-line ${type}`;
  el.textContent = `[${new Date().toTimeString().slice(0,8)}] ${msg}`;
  const area = document.getElementById('logArea');
  area.appendChild(el);
  area.scrollTop = area.scrollHeight;
}

function toast(msg, isErr = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isErr ? ' err' : '');
  clearTimeout(t._to);
  t._to = setTimeout(() => t.classList.remove('show'), 4000);
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// API key
function saveKey() {
  apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { toast('Enter your Groq API key first', true); return; }
  localStorage.setItem('groq_key', apiKey);
  document.getElementById('connDot').className = 'conn-indicator ok';
  document.getElementById('connLbl').textContent = 'KEY SAVED';
  log('API key saved', 's');
  toast('API key saved!');
}

function toggleKey() {
  const inp = document.getElementById('apiKey');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

// Topics
document.getElementById('topicGrid').addEventListener('click', e => {
  const btn = e.target.closest('.topic-chip');
  if (!btn) return;
  document.querySelectorAll('.topic-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentTopic = btn.dataset.t;
  document.getElementById('custTopic').value = '';
});

// Language
function setLang(btn) {
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentLang = btn.dataset.lang;
  document.getElementById('stLang').textContent =
    currentLang === 'english' ? 'EN' : currentLang === 'hindi' ? 'HI' : 'HI/EN';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GROQ CONNECTION TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testGroq() {
  apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { toast('Paste your API key first!', true); return; }

  // Sanitize key â€” remove accidental spaces/newlines
  apiKey = apiKey.replace(/\s+/g, '');
  document.getElementById('apiKey').value = apiKey;

  const dot = document.getElementById('connDot');
  const lbl = document.getElementById('connLbl');
  dot.className = 'conn-indicator loading'; lbl.textContent = 'PINGING...';

  log('Testing Groq...', 'i');
  log('Key prefix: ' + apiKey.slice(0, 8) + '...', 'i');
  log('Key length: ' + apiKey.length, 'i');

  if (!apiKey.startsWith('gsk_')) {
    dot.className = 'conn-indicator err'; lbl.textContent = 'BAD KEY FORMAT';
    log('Key should start with gsk_ â€” check your key!', 'e');
    toast('Key must start with gsk_', true); return;
  }

  try {
    log('Sending request to Groq...', 'i');
    const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: [{ role: 'user', content: 'Reply with one word: OK' }],
        max_tokens: 5,
        stream: false
      })
    });

    log('HTTP status: ' + r.status, r.ok ? 's' : 'e');
    const text = await r.text();
    log('Raw response: ' + text.slice(0, 120), 'i');

    let d;
    try { d = JSON.parse(text); } catch(pe) {
      throw new Error('Non-JSON response: ' + text.slice(0,80));
    }

    if (!r.ok) {
      const msg = d?.error?.message || d?.error?.code || ('HTTP ' + r.status);
      throw new Error(msg);
    }

    dot.className = 'conn-indicator ok';
    lbl.textContent = 'CONNECTED âœ“';
    log('Groq works! âœ“', 's');
    toast('Connected! Now click Generate ğŸš€');
    localStorage.setItem('groq_key', apiKey);

  } catch(e) {
    dot.className = 'conn-indicator err';
    lbl.textContent = 'FAILED';
    log('Full error: ' + e.message, 'e');

    if (e.message.includes('401') || e.message.includes('invalid_api_key') || e.message.includes('Unauthorized')) {
      log('âŒ Wrong/expired API key', 'e');
      log('â†’ Go to console.groq.com and create a new key', 'w');
      toast('Invalid API key â€” create a new one at console.groq.com', true);
    } else if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError') || e.message.includes('Load failed')) {
      log('âŒ Network/CORS error', 'e');
      log('â†’ Try opening the file on a server (not file://)', 'w');
      log('â†’ Or deploy to Netlify first, then test', 'w');
      toast('Network error â€” deploy to Netlify then test!', true);
    } else if (e.message.includes('429')) {
      log('Rate limit hit â€” wait a moment', 'w');
      toast('Rate limit â€” wait 10 seconds and try again', true);
    } else {
      log('â†’ Try deploying to Netlify first', 'w');
      toast('Error: ' + e.message.slice(0,60), true);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generate() {
  apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { toast('Enter your Groq API key first!', true); return; }

  const custom = document.getElementById('custTopic').value.trim();
  const topic = custom || currentTopic;
  const model = document.getElementById('modelSel').value;
  const btn = document.getElementById('genBtn');

  btn.disabled = true; btn.textContent = 'â³ GENERATING...';
  log(`Generating: "${topic}" [${currentLang}]`, 'i');
  log(`Model: ${model}`, 'i');

  const langInstructions = {
    english: 'Write in clear, professional English.',
    hindi: 'à¤¸à¤®à¤¾à¤šà¤¾à¤° à¤ªà¥‚à¤°à¥€ à¤¤à¤°à¤¹ à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤²à¤¿à¤–à¥‡à¤‚à¥¤ (Write the entire script in Hindi)',
    hinglish: 'Write in Hinglish â€” mix Hindi and English naturally like Indian news anchors do. Example: "Aaj ki breaking news yeh hai ke technology sector mein ek bada change aaya hai."'
  };

  const prompt = `You are a professional TV news anchor. Write a compelling, engaging news broadcast script (150-200 words) about: "${topic}".

${langInstructions[currentLang]}

Format rules:
- Start with "Good evening" (or appropriate greeting in the chosen language)
- Include 2-3 distinct news stories
- Use present tense, active voice
- Sound natural when spoken aloud
- NO stage directions, NO formatting symbols, just the spoken words

Write ONLY the script, nothing else.`;

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 600,
        temperature: 0.8,
        stream: true
      })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || 'HTTP ' + res.status);
    }

    log('Streaming response...', 's');
    const scriptEl = document.getElementById('scriptArea');
    scriptEl.innerHTML = ''; script = '';

    const reader = res.body.getReader();
    const dec = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        const clean = line.replace(/^data: /, '').trim();
        if (!clean || clean === '[DONE]') continue;
        try {
          const d = JSON.parse(clean);
          const token = d.choices?.[0]?.delta?.content || '';
          if (token) {
            script += token;
            scriptEl.innerHTML = esc(script).replace(/\n\n/g,'<br><br>').replace(/\n/g,' ');
            scriptEl.scrollTop = scriptEl.scrollHeight;
          }
        } catch(e) {}
      }
    }

    // Finalize
    scriptWords = script.trim().split(/\s+/);
    renderWords();
    updateStats();
    updateTicker(topic, script);
    log(`Done! ${scriptWords.length} words generated`, 's');
    toast('Script ready! Hit â–¶ BROADCAST ğŸ™ï¸');

  } catch(e) {
    log('Error: ' + e.message, 'e');
    toast(e.message, true);
    document.getElementById('scriptArea').innerHTML =
      `<div style="color:rgba(255,26,46,0.7);font-family:Space Mono,monospace;font-size:10px;line-height:2">
      // ERROR: ${esc(e.message)}<br>
      // Make sure your Groq API key is valid<br>
      // Get one free at console.groq.com</div>`;
  }
  btn.disabled = false; btn.textContent = 'âš¡ GENERATE';
}

function updateStats() {
  document.getElementById('stWords').textContent = scriptWords.length;
  document.getElementById('stSent').textContent = (script.match(/[.!?à¥¤]/g) || []).length;
  const rate = parseFloat(document.getElementById('rateR').value);
  const secs = Math.round(scriptWords.length / (145 * rate / 60));
  document.getElementById('stTime').textContent = secs > 60 ? Math.round(secs/60) + 'm' : secs + 's';
}

function renderWords() {
  const el = document.getElementById('scriptArea');
  el.innerHTML = ''; wordEls = [];
  script.trim().split(/(\s+)/).forEach(tok => {
    if (/\s+/.test(tok)) {
      el.appendChild(document.createTextNode(tok));
    } else {
      const s = document.createElement('span');
      s.textContent = tok;
      el.appendChild(s);
      wordEls.push(s);
    }
  });
}

function updateTicker(topic, text) {
  const preview = text.split(' ').slice(0, 14).join(' ') + '...';
  const item = `<span class="tick-item">BREAKING: ${topic.toUpperCase()} â€” ${esc(preview)} <span class="tick-sep">///</span></span>`;
  document.getElementById('tickerTrack').innerHTML = item.repeat(8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TTS + LIP SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function broadcast() {
  if (!script) { toast('Generate a script first!', true); return; }
  stopBroadcast();

  utt = new SpeechSynthesisUtterance(script);
  const vi = document.getElementById('voiceSel').value;
  if (voices[vi]) utt.voice = voices[vi];
  utt.rate = parseFloat(document.getElementById('rateR').value);
  utt.pitch = parseFloat(document.getElementById('pitchR').value);
  utt.volume = 1;

  speaking = true;
  document.getElementById('speakRing').classList.add('active');

  // Fallback mouth animation
  let fb = setInterval(() => {
    if (!speaking) { clearInterval(fb); targetMouth = 0; return; }
    // Vary mouth based on time to simulate natural speech rhythm
    const t = Date.now() / 1000;
    targetMouth = Math.max(0, 0.15 + Math.sin(t * 8) * 0.3 + Math.sin(t * 3.7) * 0.2 + Math.random() * 0.15);
  }, 80);

  utt.onboundary = e => {
    if (e.name === 'word') {
      // Find word index
      let wi = 0, acc = 0;
      for (let i = 0; i < scriptWords.length; i++) {
        if (acc >= e.charIndex) { wi = i; break; }
        acc += scriptWords[i].length + 1; wi = i;
      }
      // Highlight
      wordEls.forEach(el => el.classList.remove('w-hi'));
      if (wordEls[wi]) {
        wordEls[wi].classList.add('w-hi');
        wordEls[wi].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
      // Mouth: vowel-based
      const w = scriptWords[wi] || '';
      const vowels = (w.match(/[aeiouAEIOU]/g) || []).length;
      const ratio = vowels / Math.max(1, w.length);
      targetMouth = Math.min(1, 0.2 + ratio * 0.8 + Math.random() * 0.15);

      // Progress
      document.getElementById('progFill').style.width = (wi / scriptWords.length * 100) + '%';
    }
  };

  utt.onend = () => {
    speaking = false; targetMouth = 0; clearInterval(fb);
    document.getElementById('speakRing').classList.remove('active');
    wordEls.forEach(el => el.classList.remove('w-hi'));
    document.getElementById('progFill').style.width = '100%';
    log('Broadcast complete', 's');
    toast('Broadcast complete! ğŸ™ï¸');
    setTimeout(() => document.getElementById('progFill').style.width = '0%', 2500);
  };

  utt.onerror = e => {
    speaking = false; targetMouth = 0; clearInterval(fb);
    document.getElementById('speakRing').classList.remove('active');
    log('TTS error: ' + e.error, 'e');
  };

  window.speechSynthesis.speak(utt);
  log('Broadcasting...', 's');
}

function stopBroadcast() {
  window.speechSynthesis.cancel();
  speaking = false; targetMouth = 0;
  document.getElementById('speakRing').classList.remove('active');
  wordEls.forEach(el => el.classList.remove('w-hi'));
  document.getElementById('progFill').style.width = '0%';
}

// Chrome speech resume fix
setInterval(() => {
  if (speaking && window.speechSynthesis.paused) window.speechSynthesis.resume();
}, 13000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3D AVATAR RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cv = document.getElementById('c');
const cx = cv.getContext('2d');
const CW = cv.width, CH = cv.height;

function lerp(a, b, t) { return a + (b - a) * t; }

function drawFrame() {
  cx.clearRect(0, 0, CW, CH);

  breathPhase += 0.018; glowPulse += 0.025;
  const breathY = Math.sin(breathPhase) * 2.5;
  const headBob = speaking ? Math.sin(breathPhase * 2.1) * 2 : 0;
  mouthOpen = lerp(mouthOpen, targetMouth, 0.3);

  // Random blink
  if (Math.random() < 0.004) eyeBlink = 1;
  if (eyeBlink > 0) eyeBlink = Math.max(0, eyeBlink - 0.12);

  const ox = CW / 2;
  const oy = CH / 2 - 15 + breathY + headBob;

  // === BODY / SUIT ===
  cx.save();
  const bodyG = cx.createLinearGradient(ox - 110, oy + 90, ox + 110, oy + 200);
  bodyG.addColorStop(0, '#050510');
  bodyG.addColorStop(0.3, '#0a0a1a');
  bodyG.addColorStop(1, '#050508');
  cx.fillStyle = bodyG;
  cx.beginPath();
  cx.moveTo(ox - 110, CH);
  cx.lineTo(ox - 95, oy + 110);
  cx.lineTo(ox - 22, oy + 80);
  cx.lineTo(ox + 22, oy + 80);
  cx.lineTo(ox + 95, oy + 110);
  cx.lineTo(ox + 110, CH);
  cx.fill();

  // Suit lapels
  cx.fillStyle = '#080818';
  cx.beginPath();
  cx.moveTo(ox - 22, oy + 80);
  cx.lineTo(ox - 50, oy + 130);
  cx.lineTo(ox, oy + 110);
  cx.closePath(); cx.fill();
  cx.beginPath();
  cx.moveTo(ox + 22, oy + 80);
  cx.lineTo(ox + 50, oy + 130);
  cx.lineTo(ox, oy + 110);
  cx.closePath(); cx.fill();

  // Shirt
  cx.fillStyle = '#e8e8ec';
  cx.beginPath();
  cx.moveTo(ox - 14, oy + 80);
  cx.lineTo(ox + 14, oy + 80);
  cx.lineTo(ox + 10, oy + 155);
  cx.lineTo(ox, oy + 160);
  cx.lineTo(ox - 10, oy + 155);
  cx.closePath(); cx.fill();

  // Tie
  const tieG = cx.createLinearGradient(ox - 7, oy + 84, ox + 7, oy + 84);
  tieG.addColorStop(0, '#1a0030');
  tieG.addColorStop(0.5, '#3d0060');
  tieG.addColorStop(1, '#1a0030');
  cx.fillStyle = tieG;
  cx.beginPath();
  cx.moveTo(ox - 5, oy + 84);
  cx.lineTo(ox + 5, oy + 84);
  cx.lineTo(ox + 8, oy + 160);
  cx.lineTo(ox, oy + 172);
  cx.lineTo(ox - 8, oy + 160);
  cx.closePath(); cx.fill();
  // Tie shine
  cx.fillStyle = 'rgba(200,100,255,0.2)';
  cx.beginPath();
  cx.moveTo(ox - 2, oy + 87);
  cx.lineTo(ox + 1, oy + 87);
  cx.lineTo(ox + 3, oy + 130);
  cx.lineTo(ox, oy + 130);
  cx.closePath(); cx.fill();
  cx.restore();

  // === NECK ===
  cx.save();
  const neckG = cx.createLinearGradient(ox - 18, oy + 70, ox + 18, oy + 70);
  neckG.addColorStop(0, '#2a1508');
  neckG.addColorStop(0.4, '#5a3018');
  neckG.addColorStop(1, '#2a1508');
  cx.fillStyle = neckG;
  cx.beginPath();
  cx.moveTo(ox - 18, oy + 80);
  cx.lineTo(ox + 18, oy + 80);
  cx.lineTo(cx.lineTo ? cx.lineTo : (function(){}), cx.lineTo ? cx.lineTo : (function(){}));
  cx.restore();

  // redraw neck properly
  cx.save();
  const ng2 = cx.createLinearGradient(ox-18, oy+70, ox+18, oy+70);
  ng2.addColorStop(0,'#2a1508'); ng2.addColorStop(0.5,'#5a3018'); ng2.addColorStop(1,'#2a1508');
  cx.fillStyle = ng2;
  cx.fillRect(ox - 18, oy + 70, 36, 55);
  cx.restore();

  // === HEAD ===
  cx.save();
  // Head glow when speaking
  const ga = 0.12 + Math.sin(glowPulse) * 0.04;
  if (speaking) {
    cx.shadowColor = `rgba(0,240,255,${ga * 2.5})`;
    cx.shadowBlur = 50;
  } else {
    cx.shadowColor = `rgba(0,240,255,${ga})`;
    cx.shadowBlur = 20;
  }

  // Head shape
  const headG = cx.createRadialGradient(ox - 18, oy - 35, 8, ox, oy, 92);
  headG.addColorStop(0, '#7a4530');
  headG.addColorStop(0.4, '#5a3020');
  headG.addColorStop(0.8, '#3d1e10');
  headG.addColorStop(1, '#1a0a05');
  cx.fillStyle = headG;
  cx.beginPath();
  cx.ellipse(ox, oy, 82, 98, 0, 0, Math.PI * 2);
  cx.fill();
  cx.shadowBlur = 0;
  cx.restore();

  // Face highlight
  cx.save();
  cx.globalAlpha = 0.15;
  const fhG = cx.createRadialGradient(ox - 20, oy - 40, 5, ox - 10, oy - 20, 55);
  fhG.addColorStop(0, '#fff');
  fhG.addColorStop(1, 'transparent');
  cx.fillStyle = fhG;
  cx.beginPath(); cx.ellipse(ox, oy, 82, 98, 0, 0, Math.PI * 2); cx.fill();
  cx.restore();

  // Cheek blush
  cx.save(); cx.globalAlpha = 0.08;
  cx.fillStyle = '#ff6040';
  cx.beginPath(); cx.ellipse(ox - 52, oy + 15, 20, 13, -0.3, 0, Math.PI*2); cx.fill();
  cx.beginPath(); cx.ellipse(ox + 52, oy + 15, 20, 13, 0.3, 0, Math.PI*2); cx.fill();
  cx.restore();

  // === HAIR ===
  cx.save();
  const hairG = cx.createLinearGradient(ox - 85, oy - 110, ox + 85, oy - 55);
  hairG.addColorStop(0, '#050505');
  hairG.addColorStop(0.5, '#181818');
  hairG.addColorStop(1, '#050505');
  cx.fillStyle = hairG;
  cx.beginPath();
  cx.ellipse(ox, oy - 55, 85, 52, 0, Math.PI, 0);
  cx.fill();
  // Hair highlights
  cx.globalAlpha = 0.12;
  cx.fillStyle = '#606080';
  cx.beginPath();
  cx.ellipse(ox - 25, oy - 88, 25, 8, -0.2, 0, Math.PI * 2);
  cx.fill();
  cx.restore();

  // Side part
  cx.save(); cx.globalAlpha = 0.3;
  cx.strokeStyle = '#222'; cx.lineWidth = 2; cx.lineCap = 'round';
  cx.beginPath();
  cx.moveTo(ox - 15, oy - 97);
  cx.quadraticCurveTo(ox - 12, oy - 75, ox - 8, oy - 60);
  cx.stroke(); cx.restore();

  // === EARS ===
  for (let side = -1; side <= 1; side += 2) {
    cx.save();
    const earG = cx.createRadialGradient(ox + side*86, oy+8, 2, ox + side*86, oy+8, 16);
    earG.addColorStop(0, '#7a4530'); earG.addColorStop(1, '#2a1008');
    cx.fillStyle = earG;
    cx.beginPath();
    cx.ellipse(ox + side * 86, oy + 8, 11, 19, side * 0.15, 0, Math.PI * 2);
    cx.fill();
    // Inner ear
    cx.fillStyle = 'rgba(120,60,30,0.5)';
    cx.beginPath();
    cx.ellipse(ox + side * 86, oy + 10, 5, 10, side * 0.1, 0, Math.PI * 2);
    cx.fill();
    cx.restore();
  }

  // === EYES ===
  for (let side = -1; side <= 1; side += 2) {
    const ex = ox + side * 29;
    const ey = oy - 20;
    const bs = 1 - eyeBlink; // blink scale

    cx.save();
    // Eye socket shadow
    cx.fillStyle = 'rgba(0,0,0,0.5)';
    cx.beginPath(); cx.ellipse(ex, ey + 1, 21, 14, 0, 0, Math.PI * 2); cx.fill();

    // Sclera (white)
    cx.fillStyle = '#eeeae0';
    cx.beginPath(); cx.ellipse(ex, ey, 17, 11 * bs, 0, 0, Math.PI * 2); cx.fill();

    // Iris gradient
    const irisG = cx.createRadialGradient(ex - 2, ey - 2, 1, ex, ey, 9);
    irisG.addColorStop(0, '#00ccff');
    irisG.addColorStop(0.4, '#0088cc');
    irisG.addColorStop(0.8, '#005588');
    irisG.addColorStop(1, '#002244');
    cx.fillStyle = irisG;
    cx.beginPath(); cx.ellipse(ex, ey, 9, 9 * bs, 0, 0, Math.PI * 2); cx.fill();

    // Pupil
    cx.fillStyle = '#000';
    cx.beginPath(); cx.ellipse(ex, ey, 4.5, 4.5 * bs, 0, 0, Math.PI * 2); cx.fill();

    // Catchlight 1
    cx.fillStyle = 'rgba(255,255,255,0.85)';
    cx.beginPath(); cx.ellipse(ex - 3, ey - 3, 2.5, 1.8 * bs, 0.4, 0, Math.PI * 2); cx.fill();
    // Catchlight 2 (small)
    cx.fillStyle = 'rgba(255,255,255,0.4)';
    cx.beginPath(); cx.ellipse(ex + 2, ey + 2, 1.2, 1.0 * bs, 0, 0, Math.PI * 2); cx.fill();

    // Eyelashes / upper lid
    cx.strokeStyle = '#1a0a00';
    cx.lineWidth = 3.5; cx.lineCap = 'round';
    cx.beginPath();
    cx.moveTo(ex - 17, ey);
    cx.quadraticCurveTo(ex, ey - 14 * bs, ex + 17, ey);
    cx.stroke();

    // Lower lid
    cx.lineWidth = 1.5; cx.strokeStyle = 'rgba(100,60,40,0.4)';
    cx.beginPath();
    cx.moveTo(ex - 14, ey + 2 * bs);
    cx.quadraticCurveTo(ex, ey + 9 * bs, ex + 14, ey + 2 * bs);
    cx.stroke();

    // Eyebrow
    cx.strokeStyle = '#0d0d0d'; cx.lineWidth = 4; cx.lineCap = 'round';
    const browTilt = side === -1 ? 1 : -1;
    cx.beginPath();
    cx.moveTo(ex - 19, ey - 20 + browTilt * 2);
    cx.quadraticCurveTo(ex - 2, ey - 28, ex + 19, ey - 20 - browTilt * 2);
    cx.stroke();
    cx.restore();
  }

  // === NOSE ===
  cx.save();
  cx.strokeStyle = 'rgba(0,0,0,0.35)'; cx.lineWidth = 2; cx.lineCap = 'round'; cx.lineJoin = 'round';
  cx.beginPath();
  cx.moveTo(ox, oy - 8);
  cx.lineTo(ox - 4, oy + 14);
  cx.quadraticCurveTo(ox, oy + 18, ox + 4, oy + 14);
  cx.stroke();
  // Nostrils
  cx.fillStyle = 'rgba(0,0,0,0.25)';
  cx.beginPath(); cx.ellipse(ox - 8, oy + 17, 4, 3, -0.3, 0, Math.PI*2); cx.fill();
  cx.beginPath(); cx.ellipse(ox + 8, oy + 17, 4, 3, 0.3, 0, Math.PI*2); cx.fill();
  cx.restore();

  // === MOUTH ===
  const MY = oy + 42;
  const MW = 28;

  cx.save();
  // Mouth cavity
  const cavDepth = Math.max(2, mouthOpen * 14);
  cx.fillStyle = '#0d0000';
  cx.beginPath();
  cx.ellipse(ox, MY + mouthOpen * 2, MW * 0.9, cavDepth, 0, 0, Math.PI * 2);
  cx.fill();

  // Teeth top
  if (mouthOpen > 0.18) {
    cx.fillStyle = '#f5f0e8';
    const toothH = mouthOpen * 7;
    cx.beginPath();
    cx.rect(ox - MW * 0.7, MY - mouthOpen * 5, MW * 1.4, toothH);
    cx.fill();
    // Tooth dividers
    cx.strokeStyle = 'rgba(200,190,170,0.4)'; cx.lineWidth = 1;
    for (let i = -2; i <= 2; i++) {
      cx.beginPath();
      cx.moveTo(ox + i * (MW * 0.3), MY - mouthOpen * 5);
      cx.lineTo(ox + i * (MW * 0.3), MY - mouthOpen * 5 + toothH);
      cx.stroke();
    }
    // Bottom teeth
    cx.fillStyle = '#ede8de';
    cx.beginPath();
    cx.rect(ox - MW * 0.6, MY + mouthOpen * 3, MW * 1.2, mouthOpen * 5);
    cx.fill();
  }

  // Upper lip
  const ulG = cx.createLinearGradient(ox - MW, MY, ox + MW, MY);
  ulG.addColorStop(0, '#7a3020'); ulG.addColorStop(0.5, '#a04030'); ulG.addColorStop(1, '#7a3020');
  cx.fillStyle = ulG;
  cx.beginPath();
  cx.moveTo(ox - MW - 2, MY);
  // Cupid's bow
  cx.bezierCurveTo(ox - MW * 0.7, MY - 4 - mouthOpen * 4, ox - MW * 0.2, MY - 7 - mouthOpen * 3, ox, MY - 4 - mouthOpen * 2);
  cx.bezierCurveTo(ox + MW * 0.2, MY - 7 - mouthOpen * 3, ox + MW * 0.7, MY - 4 - mouthOpen * 4, cx.moveTo ? ox + MW + 2 : ox + MW + 2, MY);
  cx.lineTo(ox + MW + 2, MY);
  cx.quadraticCurveTo(ox, MY + 3, ox - MW - 2, MY);
  cx.fill();

  // Lower lip
  const llG = cx.createLinearGradient(ox - MW, MY + 10, ox + MW, MY + 10);
  llG.addColorStop(0, '#8a3828'); llG.addColorStop(0.5, '#b04838'); llG.addColorStop(1, '#8a3828');
  cx.fillStyle = llG;
  cx.beginPath();
  cx.moveTo(ox - MW, MY + 2);
  cx.bezierCurveTo(ox - MW * 0.6, MY + 14 + mouthOpen * 12, ox + MW * 0.6, MY + 14 + mouthOpen * 12, ox + MW, MY + 2);
  cx.bezierCurveTo(ox + MW * 0.3, MY + 18 + mouthOpen * 12, ox - MW * 0.3, MY + 18 + mouthOpen * 12, ox - MW, MY + 2);
  cx.fill();
  // Lip shine
  cx.globalAlpha = 0.2;
  cx.fillStyle = '#ffddcc';
  cx.beginPath(); cx.ellipse(ox, MY + 8 + mouthOpen * 4, 15, 4 + mouthOpen * 2, 0, 0, Math.PI*2); cx.fill();
  cx.restore();

  // === DESK ===
  cx.save();
  const deskG = cx.createLinearGradient(0, oy + 192, 0, CH);
  deskG.addColorStop(0, '#0d0d20');
  deskG.addColorStop(0.3, '#08081a');
  deskG.addColorStop(1, '#040408');
  cx.fillStyle = deskG;
  cx.fillRect(0, oy + 192, CW, CH);
  // Desk top edge glow
  cx.strokeStyle = 'rgba(0,240,255,0.25)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(0, oy + 193); cx.lineTo(CW, oy + 193); cx.stroke();
  // Desk reflection
  cx.globalAlpha = 0.05;
  const reflG = cx.createLinearGradient(0, oy + 193, 0, oy + 230);
  reflG.addColorStop(0, 'rgba(0,240,255,0.5)'); reflG.addColorStop(1, 'transparent');
  cx.fillStyle = reflG; cx.fillRect(0, oy + 193, CW, 40);
  cx.restore();

  requestAnimationFrame(drawFrame);
}
requestAnimationFrame(drawFrame);

// Visualizer
const vizEl = document.getElementById('viz');
const vBars = [];
for (let i = 0; i < 20; i++) {
  const b = document.createElement('div');
  b.className = 'vbar'; vizEl.appendChild(b); vBars.push(b);
}
setInterval(() => {
  vBars.forEach((b, i) => {
    const h = speaking ? 2 + Math.abs(Math.sin(Date.now()/100 + i * 0.8)) * 16 : 2;
    b.style.height = h + 'px';
  });
}, 60);
</script>
</body>
</html>
